const sequelize = require("sequelize");
const mcpadc = require("mcp-spi-adc");
const db = require("../../models");
const tableauCorrespondanceHumidite = require("../../utils/functions/tableauDeCorrespondancesHumidite");
const gestionHumModels = db.gestionHum;
const gestionHumDataModels = db.gestionHumData;
const gestionCourbesModels = db.gestionCourbes;
const gestionSecEtallonnageModels = db.etalonnageSec;
const gestionHumEtallonnageModels = db.etalonnageHum;
const {
  gpioActionOn,
  gpioActionOff,
} = require("../../utils/functions/myfunctions");

//? RÃ©cupÃ©ration des datas humiditÃ©.

let consigne;
let pas;
let objectif;

let recuperationDesDatasHumidite = () => {
  return new Promise((resolve, reject) => {
    try {
      gestionHumDataModels
        .findOne({
          attributes: [[sequelize.fn("max", sequelize.col("id")), "maxid"]],
          raw: true,
        })
        .then((id) => {
          if (!id || !id.maxid) {
            throw new Error("L'id max n'a pas pu Ãªtre rÃ©cupÃ©rÃ©.");
          }

          return gestionHumDataModels.findOne({
            where: { id: id.maxid },
          });
        })
        .then((result) => {
          if (result) {
            consigne = result.consigneHum;
            pas = result.pasHum;
            objectif = result.objectifHum;

            console.log(
              "âœ… SUCCÃˆS | Gestion HumiditÃ© 1 | RÃ©cupÃ©ration des datas :",
              {
                consigne,
                pas,
                objectif,
              }
            );

            resolve({ consigne, pas, objectif });
          } else {
            throw new Error("Aucun rÃ©sultat trouvÃ© pour l'id max.");
          }
        })
        .catch((error) => {
          console.log(
            "ðŸ”´ ERROR | Gestion HumiditÃ© | RÃ©cupÃ©ration de la consigne humiditÃ©",
            error
          );
          reject(error);
        });
    } catch (error) {
      console.log(
        "ðŸ”´ ERROR | Gestion HumiditÃ© | RÃ©cupÃ©ration de la consigne humiditÃ©",
        error
      );
      reject(error);
    }
  });
};

//? -------------------------------------------------

//? Construction de la valeur de l'axe x.

let dateDemarrageCycle;
let jourDuCycle;
let heureDuCycle;
let minuteDuCycle;
let heureMinute;
let valeurAxeX;

let constructionDeLaValeurDeLaxeX = () => {
  return new Promise((resolve, reject) => {
    try {
      gestionCourbesModels
        .findOne({
          attributes: [[sequelize.fn("max", sequelize.col("id")), "maxid"]],
          raw: true,
        })
        .then((id) => {
          if (!id) {
            throw new Error("No max ID found");
          }

          return gestionCourbesModels.findOne({
            where: { id: id.maxid },
          });
        })
        .then((result) => {
          if (!result) {
            throw new Error("No record found with max ID");
          }

          dateDemarrageCycle = new Date(result.dateDemarrageCycle);

          console.log(
            "âœ… SUCCÃˆS | Gestion HumiditÃ© 2 | Date de dÃ©marrage du cycle :",
            dateDemarrageCycle
          );

          const nbJourBrut =
            new Date().getTime() - dateDemarrageCycle.getTime();
          jourDuCycle = Math.round(nbJourBrut / (1000 * 3600 * 24)) + 1;
          heureDuCycle = new Date().getHours();
          minuteDuCycle = new Date().getMinutes();

          if (minuteDuCycle < 10) {
            minuteDuCycle = `0${minuteDuCycle}`;
          }

          heureMinute = `${heureDuCycle}h${minuteDuCycle}`;
          valeurAxeX = `Jour ${jourDuCycle} - ${heureMinute}`;

          console.log(
            "âœ… SUCCÃˆS | Gestion HumiditÃ© 3 | Construction de la valeur de l'axe X : ",
            valeurAxeX
          );

          resolve(valeurAxeX);
        })
        .catch((error) => {
          console.log(
            "ðŸ”´ ERROR | Gestion HumiditÃ© | Construction de la valeur de l'axe X",
            error
          );
          reject(error);
        });
    } catch (error) {
      console.log(
        "ðŸ”´ ERROR | Gestion HumiditÃ© | Construction de la valeur de l'axe X",
        error
      );
      reject(error);
    }
  });
};

//? --------------------------------------------------

//? RÃ©cupÃ©ration de l'Ã©talonnage Sec.

let etalonnageSec;

let recuperationDeEtalonageSec = () => {
  return new Promise((resolve, reject) => {
    try {
      gestionSecEtallonnageModels
        .findOne({
          attributes: [[sequelize.fn("max", sequelize.col("id")), "maxid"]],
          raw: true,
        })
        .then((id) => {
          if (!id) {
            throw new Error("No max ID found");
          }

          return gestionSecEtallonnageModels.findOne({
            where: { id: id.maxid },
          });
        })
        .then((result) => {
          if (!result) {
            throw new Error("No record found with max ID");
          }

          etalonnageSec = result.etalonnageSec;

          console.log(
            "âœ… SUCCÃˆS | Gestion HumiditÃ© 4 | RÃ©cupÃ©ration de l'Ã©talonage Sec :",
            etalonnageSec
          );

          resolve(etalonnageSec);
        })
        .catch((error) => {
          console.log(
            "ðŸ”´ ERROR | Gestion HumiditÃ© | RÃ©cupÃ©ration de l'Ã©talonage Sec",
            error
          );
          reject(error);
        });
    } catch (error) {
      console.log(
        "ðŸ”´ ERROR | Gestion HumiditÃ© | RÃ©cupÃ©ration de l'Ã©talonage Sec",
        error
      );
      reject(error);
    }
  });
};

//? --------------------------------------------------

//? Mesure de la tempÃ©rature moyenne Sec.

let mcpBrocheSec = 0;
let listValSecHumidite = [];

let mesureDeLaTemperatureMoyenneSec = () => {
  return new Promise((resolve, reject) => {
    try {
      let temps = 0;
      let conteur;

      let count = () => {
        temps++;

        if (temps === 39) {
          clearInterval(conteur);
        }

        const tempSensor = mcpadc.open(
          mcpBrocheSec,
          { speedHz: 20000 },
          (err) => {
            if (err) {
              clearInterval(conteur);
              reject(err);
              return;
            }

            tempSensor.read((err, reading) => {
              if (err) {
                clearInterval(conteur);
                reject(err);
                return;
              }

              listValSecHumidite.push(reading.value * 40);

              let lastIndex = listValSecHumidite.length;
              console.log(
                "âœ… SUCCÃˆS | Gestion HumiditÃ© 5 | Mesure " +
                  lastIndex +
                  "/40 de la tempÃ©rature Sec : " +
                  reading.value
              );

              if (listValSecHumidite.length >= 39) {
                clearInterval(conteur);
                resolve(listValSecHumidite);
              }
            });
          }
        );
      };

      conteur = setInterval(count, 1000);
    } catch (error) {
      console.log(
        "ðŸ”´ ERROR | Gestion HumiditÃ© | Mesure de la tempÃ©rature Sec : ",
        error
      );

      reject(error);
    }
  });
};

//? --------------------------------------------------

//? Calcule de la tempÃ©rature moyenne Sec.

let temperatureMoyenneSec;

let calculeDeLaTemperatureMoyenneSec = () => {
  return new Promise((resolve, reject) => {
    try {
      let arrayLength = listValSecHumidite.length;

      if (arrayLength === 0) {
        throw new Error("La liste des valeurs de tempÃ©rature Sec est vide.");
      }

      const sumlistVal = listValSecHumidite.reduce(
        (accumulator, curr) => accumulator + curr,
        0
      );
      temperatureMoyenneSec = sumlistVal / arrayLength;

      console.log(
        "âœ… SUCCÃˆS | Gestion HumiditÃ© 6 | Temperature moyenne Sec Brute : ",
        temperatureMoyenneSec
      );

      resolve(temperatureMoyenneSec);
    } catch (error) {
      console.log(
        "ðŸ”´ ERROR | Gestion HumiditÃ© | Temperature moyenne HumiditÃ© : ",
        error
      );

      reject(error);
    }
  });
};

//? --------------------------------------------------

//? Calcule de la tempÃ©rature corrigÃ©e Sec.

let temperatureCorrigeeSec;

let calculeDeLaTempÃ©ratureCorrigeeSec = () => {
  return new Promise((resolve, reject) => {
    try {
      if (
        typeof temperatureMoyenneSec === "undefined" ||
        typeof etalonnageSec === "undefined"
      ) {
        throw new Error(
          "Les valeurs nÃ©cessaires pour calculer la tempÃ©rature corrigÃ©e ne sont pas dÃ©finies."
        );
      }

      temperatureCorrigeeSec = parseFloat(
        (temperatureMoyenneSec + etalonnageSec).toFixed(1)
      );

      console.log(
        "âœ… SUCCÃˆS | Gestion HumiditÃ© 7 | Calcule de la tempÃ©rature corrigÃ©e Sec : ",
        temperatureCorrigeeSec
      );

      resolve(temperatureCorrigeeSec);
    } catch (error) {
      console.log(
        "ðŸ”´ ERROR | Gestion HumiditÃ© | Calcule de la tempÃ©rature corrigÃ©e Sec : ",
        error
      );

      reject(error);
    }
  });
};

//? --------------------------------------------------

//? Tableau de correspondance.

// let temperatureCorrigeeSecTest = 10.5;
let correspondancePressions;

const getCorrespondanceSec = () => {
  return new Promise((resolve, reject) => {
    try {
      // Appel direct de la fonction car elle retourne une valeur synchrone
      correspondancePressions = tableauCorrespondanceHumidite(
        temperatureCorrigeeSec
      );

      if (correspondancePressions !== undefined) {
        console.log(
          "âœ… SUCCÃˆS | Gestion HumiditÃ© 8 | Correspondance Sec : ",
          correspondancePressions
        );
        resolve(correspondancePressions);
      } else {
        throw new Error(
          "ðŸ”´ ERROR | Correspondance Sec non trouvÃ©e pour la tempÃ©rature donnÃ©e."
        );
      }
    } catch (error) {
      console.log("ðŸ”´ ERROR | gestions HumiditÃ© | Correspondance Sec", error);
      reject(error);
    }
  });
};

//? --------------------------------------------------

//? RÃ©cupÃ©ration de l'Ã©talonnage Humide.

let etalonnageHum;

let recuperationDeEtalonageHumide = () => {
  return new Promise((resolve, reject) => {
    try {
      gestionHumEtallonnageModels
        .findOne({
          attributes: [[sequelize.fn("max", sequelize.col("id")), "maxid"]],
          raw: true,
        })
        .then((id) => {
          if (!id) {
            throw new Error("No max ID found");
          }

          return gestionHumEtallonnageModels.findOne({
            where: { id: id.maxid },
          });
        })
        .then((result) => {
          if (!result) {
            throw new Error("No record found with max ID");
          }

          etalonnageHum = result.etalonnageHum;

          console.log(
            "âœ… SUCCÃˆS | Gestion HumiditÃ© 9 | RÃ©cupÃ©ration de l'Ã©talonage HumiditÃ© :",
            etalonnageHum
          );

          resolve(etalonnageHum);
        })
        .catch((error) => {
          console.log(
            "ðŸ”´ ERROR | Gestion HumiditÃ© | RÃ©cupÃ©ration de l'Ã©talonage HumiditÃ©",
            error
          );
          reject(error);
        });
    } catch (error) {
      console.log(
        "ðŸ”´ ERROR | Gestion HumiditÃ© | RÃ©cupÃ©ration de l'Ã©talonage HumiditÃ©",
        error
      );
      reject(error);
    }
  });
};

//? --------------------------------------------------

//? Mesure de la tempÃ©rature moyenne Humide.

let mcpBrocheHum = 1;
let listValHumHumidite = [];

let mesureDeLaTemperatureMoyenneHumidite = () => {
  return new Promise((resolve, reject) => {
    try {
      let temps = 0;
      let conteur;

      let count = () => {
        temps++;

        if (temps === 39) {
          clearInterval(conteur);
        }

        const tempSensor = mcpadc.open(
          mcpBrocheHum,
          { speedHz: 20000 },
          (err) => {
            if (err) {
              clearInterval(conteur);
              reject(err);
              return;
            }

            tempSensor.read((err, reading) => {
              if (err) {
                clearInterval(conteur);
                reject(err);
                return;
              }

              listValHumHumidite.push(reading.value * 40);

              let lastIndex = listValHumHumidite.length;
              console.log(
                "âœ… SUCCÃˆS | Gestion HumiditÃ© 10 | Mesure " +
                  lastIndex +
                  "/40 de la tempÃ©rature Hum : " +
                  reading.value
              );

              if (listValHumHumidite.length >= 39) {
                clearInterval(conteur);
                resolve(listValHumHumidite);
              }
            });
          }
        );
      };

      conteur = setInterval(count, 1000);
    } catch (error) {
      console.log(
        "ðŸ”´ ERROR | Gestion HumiditÃ© | Mesure de la tempÃ©rature Sec : ",
        error
      );

      reject(error);
    }
  });
};

//? --------------------------------------------------

//? Calcule de la tempÃ©rature moyenne HumiditÃ©.

let temperatureMoyenneHumidite;

let calculeDeLaTemperatureMoyenneHumidite = () => {
  return new Promise((resolve, reject) => {
    try {
      let arrayLength = listValHumHumidite.length;

      if (arrayLength === 0) {
        throw new Error(
          "La liste des valeurs de tempÃ©rature HumiditÃ© est vide."
        );
      }

      const sumlistVal = listValHumHumidite.reduce(
        (accumulator, curr) => accumulator + curr,
        0
      );
      temperatureMoyenneHumidite = sumlistVal / arrayLength;

      console.log(
        "âœ… SUCCÃˆS | Gestion HumiditÃ© 11 | Temperature moyenne HumiditÃ© Brute : ",
        temperatureMoyenneHumidite
      );

      resolve(temperatureMoyenneHumidite);
    } catch (error) {
      console.log(
        "ðŸ”´ ERROR | Gestion HumiditÃ© | Temperature moyenne HumiditÃ© : ",
        error
      );

      reject(error);
    }
  });
};

//? --------------------------------------------------

//? Calcule de la tempÃ©rature corrigÃ©e HumiditÃ©.

let temperatureCorrigeeHumide;

let calculeDeLaTemperatureCorrigeeHumide = () => {
  return new Promise((resolve, reject) => {
    try {
      if (
        typeof temperatureMoyenneHumidite === "undefined" ||
        typeof etalonnageHum === "undefined"
      ) {
        throw new Error(
          "Les valeurs nÃ©cessaires pour calculer la tempÃ©rature corrigÃ©e humiditÃ© ne sont pas dÃ©finies."
        );
      }

      temperatureCorrigeeHumide = parseFloat(
        (temperatureMoyenneHumidite + etalonnageHum).toFixed(1)
      );

      console.log(
        "âœ… SUCCÃˆS | Gestion HumiditÃ© 12 | Calcule de la tempÃ©rature corrigÃ©e HumiditÃ© : ",
        temperatureCorrigeeHumide
      );

      resolve(temperatureCorrigeeHumide);
    } catch (error) {
      console.log(
        "ðŸ”´ ERROR | Gestion HumiditÃ© | Calcule de la tempÃ©rature corrigÃ©e HumiditÃ© : ",
        error
      );

      reject(error);
    }
  });
};

//? --------------------------------------------------

//? Tableau de correspondance humiditÃ©.

let temperatureCorrigeeHumiditeTest = 11;
let correspondancePressionsHumidite;

const getCorrespondanceHumidite = () => {
  return new Promise((resolve, reject) => {
    try {
      // Appel direct de la fonction car elle retourne une valeur synchrone
      correspondancePressionsHumidite = tableauCorrespondanceHumidite(
        temperatureCorrigeeHumide
      );

      if (correspondancePressionsHumidite !== undefined) {
        console.log(
          "âœ… SUCCÃˆS | Gestion HumiditÃ© 13 | Correspondance humiditÃ© : ",
          correspondancePressionsHumidite
        );
        resolve(correspondancePressionsHumidite);
      } else {
        throw new Error(
          "ðŸ”´ THROWED ERROR | Correspondance humiditÃ© non trouvÃ©e pour la tempÃ©rature donnÃ©e."
        );
      }
    } catch (error) {
      console.log(
        "ðŸ”´ ERROR | gestions HumiditÃ© | Correspondance humiditÃ©",
        error
      );
      reject(error);
    }
  });
};

//? --------------------------------------------------

//? Calcule du taux d'humiditÃ©.

let tauxHumidite;
let deltaHum;

let calculeTauxHumidite = () => {
  return new Promise((resolve, reject) => {
    try {
      // Calcul du taux d'humiditÃ©
      tauxHumidite = parseFloat(
        (
          ((correspondancePressionsHumidite -
            1013 *
              0.000662 *
              (temperatureCorrigeeSec - temperatureCorrigeeHumide)) /
            correspondancePressions) *
          100
        ).toFixed(2)
      );

      console.log(
        "âœ… SUCCÃˆS | Gestion HumiditÃ© 14 | Taux Humidite",
        tauxHumidite
      );

      // Calcul du delta entre la consigne et le taux d'humiditÃ©
      deltaHum = parseFloat((tauxHumidite - consigne).toFixed(1));

      console.log(
        "âœ… SUCCÃˆS | Gestion HumiditÃ© 15 | Delta humiditÃ© : ",
        deltaHum
      );

      // RÃ©solution de la promesse avec les valeurs calculÃ©es
      resolve({ tauxHumidite, deltaHum });
    } catch (error) {
      console.log(
        "ðŸ”´ ERROR | gestions HumiditÃ© | Calcule du taux d'humiditÃ©",

        error
      );

      // Rejet de la promesse en cas d'erreur
      reject(error);
    }
  });
};

//? --------------------------------------------------

//? Action aprÃ¨s le calcule du delta.

let actionApresCalculeDelta = () => {
  return new Promise((resolve, reject) => {
    try {
      if (deltaHum > 2) {
        resolve(
          console.log(
            "âœ… SUCCÃˆS | Gestion HumiditÃ© 16 | DeltaHum >  2 | On ne fait rien"
          )
        );
      }

      if (deltaHum <= 2 && deltaHum >= -2) {
        //* Pas d'action car interval entre 2% et -2%"
        resolve(
          console.log(
            "âœ… SUCCÃˆS | Gestion HumiditÃ© 16 | deltaHum <= 2 && deltaHum >= -2 | Pas d'action car interval entre 2% et -2%"
          )
        );
      }

      if (deltaHum >= -5 && deltaHum < -2) {
        //* Activation de l'eau au sol.
        gpioActionOn(16);
        console.log(
          "âœ… SUCCÃˆS | Gestion HumiditÃ© 16 | deltaHum >= -5 && deltaHum < -2 | Activation de l'eau au sol"
        );

        //* DÃ©activation de l'eau au sol.
        setTimeout(() => {
          gpioActionOff(16);

          resolve(
            console.log(
              "âœ… SUCCÃˆS | Gestion HumiditÃ© 16 | DÃ©activation de l'eau au sol."
            )
          );
        }, 10000);
      }

      if (deltaHum >= -10 && deltaHum < -5) {
        //* Activation de l'eau au sol.
        gpioActionOn(16);
        console.log(
          "âœ… SUCCÃˆS | Gestion HumiditÃ© 16 | deltaHum >= -10 && deltaHum < -5 | Activation de l'eau au sol"
        );

        //* DÃ©activation de l'eau au sol.
        setTimeout(() => {
          gpioActionOff(16);

          resolve(
            console.log(
              "âœ… SUCCÃˆS | Gestion HumiditÃ© 16 | DÃ©activation de l'eau au sol."
            )
          );
        }, 10000);
      }

      if (deltaHum < -10) {
        //* Activation de l'eau au sol.
        gpioActionOn(16);
        console.log(
          "âœ… SUCCÃˆS | Gestion HumiditÃ© 16 | deltaHum < -10 | Activation de l'eau au sol"
        );

        //* DÃ©activation de l'eau au sol.
        setTimeout(() => {
          gpioActionOff(16);

          resolve(
            console.log(
              "âœ… SUCCÃˆS | Gestion HumiditÃ© 16 | DÃ©activation de l'eau au sol."
            )
          );
        }, 10000);
      }
    } catch (error) {
      reject();
      console.log("ERREUR calcul action delta :", error);
    }
  });
};

//? --------------------------------------------------

//? Enregistrement des donnÃ©es dans la BD.

let enregistrementDesDonnees = () => {
  return new Promise((resolve, reject) => {
    gestionHumModels
      .create({
        tauxHumidite: tauxHumidite,
        deltaHum: deltaHum,
        valeursMesureSec180: temperatureCorrigeeSec,
        valeursMesureHum90: temperatureCorrigeeHumide,
        consigne: consigne,
        valeurAxeX: valeurAxeX,
        jourDuCycle: jourDuCycle,
      })

      .then((result) => {
        resolve(
          console.log(
            "âœ… SUCCÃˆS | Gestion HumiditÃ© 16 | Enregistrement des donnÃ©es dans la BD sous l'ID : ",
            result.dataValues.id
          )
        );
      })
      .catch((error) => {
        reject(
          console.log(
            "ðŸ”´ ERROR | gestions HumiditÃ© | Enregistrement des donnÃ©es dans la BD : ",
            error
          )
        );
      });
  });
};

//? --------------------------------------------------

//? ExÃ©cution du script gestion humiditÃ©.
(async function gestionHumiditeHandler() {
  try {
    await recuperationDesDatasHumidite();
    await constructionDeLaValeurDeLaxeX();
    await recuperationDeEtalonageSec();
    await mesureDeLaTemperatureMoyenneSec();
    await calculeDeLaTemperatureMoyenneSec();
    await calculeDeLaTempÃ©ratureCorrigeeSec();
    await getCorrespondanceSec();
    await recuperationDeEtalonageHumide();
    await mesureDeLaTemperatureMoyenneHumidite();
    await calculeDeLaTemperatureMoyenneHumidite();
    await calculeDeLaTemperatureCorrigeeHumide();
    await getCorrespondanceHumidite();
    await calculeTauxHumidite();
    await actionApresCalculeDelta();
    await enregistrementDesDonnees();
  } catch (error) {
    console.error(
      "ðŸŸ  Erreur dans le processus d'exÃ©cution du script gestion humiditÃ©",
      JSON.stringify(error)
    );
  }
})();
